<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>Egg Identifier</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>window.FontAwesomeConfig = { autoReplaceSvg: 'nest' };</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { color-scheme: dark; }
        ::-webkit-scrollbar { display: none; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-button.active { background: linear-gradient(135deg, #FBBF24, #F59E0B); color: #000; }
        .tap-area { cursor: pointer; }
        .modal-backdrop { background: rgba(0,0,0,0.6); }
        .truncate-2 {
          display: -webkit-box;
          -webkit-line-clamp: 2;
          -webkit-box-orient: vertical;
          overflow: hidden;
        }
        /* Ensure chart container aspect handling */
        #usageChartContainer { position: relative; height: 220px; }
    </style>
</head>
<body class="bg-black text-white min-h-screen">
<div id="mobile-app" class="max-w-sm mx-auto bg-black relative">
    <header id="header" class="bg-gradient-to-r from-yellow-400 to-yellow-500 text-black p-4 sticky top-0 z-50">
        <div class="flex items-center justify-between">
            <h1 class="text-xl font-bold">EggID Pro</h1>
            <i class="fas fa-egg text-2xl"></i>
        </div>
    </header>

    <main id="main-content" class="pb-24">
        <!-- Tab 1 -->
        <div id="tab1-content" class="tab-content active p-4">
            <div id="identification-section" class="space-y-6">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-yellow-400 mb-2">Identify Your Egg</h2>
                    <p class="text-gray-300">Take or upload a photo to identify the species</p>
                </div>

                <div id="camera-section" class="bg-gray-900 rounded-xl p-6 border border-yellow-400/20">
                    <div id="tapToCapture" class="w-full h-64 bg-gray-800 rounded-lg border-2 border-dashed border-yellow-400/30 flex items-center justify-center mb-4 tap-area">
                        <div class="text-center pointer-events-none">
                            <i class="fas fa-camera text-yellow-400 text-4xl mb-3"></i>
                            <p class="text-gray-400">Tap to take photo</p>
                        </div>
                    </div>

                    <!-- Hidden inputs for camera and upload -->
                    <input id="fileInputCamera" type="file" accept="image/*" capture="environment" class="hidden" />
                    <input id="fileInputUpload" type="file" accept="image/*" class="hidden" />

                    <div class="flex gap-3">
                        <button id="btnCamera" class="flex-1 bg-gradient-to-r from-yellow-400 to-yellow-500 text-black py-3 rounded-lg font-semibold">
                            <i class="fas fa-camera mr-2"></i>Camera
                        </button>
                        <button id="btnUpload" class="flex-1 bg-gray-800 border border-yellow-400/30 text-yellow-400 py-3 rounded-lg font-semibold">
                            <i class="fas fa-upload mr-2"></i>Upload
                        </button>
                    </div>

                    <!-- Preview + result -->
                    <div id="previewBox" class="mt-5 hidden">
                        <div class="w-full rounded-lg overflow-hidden border border-yellow-400/20">
                            <img id="previewImage" alt="preview" class="w-full object-cover max-h-72" />
                        </div>
                        <div id="resultBox" class="mt-4 bg-black/30 rounded-lg p-3">
                            <p class="text-gray-300 text-sm">Result:</p>
                            <div class="flex items-center justify-between mt-2">
                                <div>
                                    <h4 id="resultTitle" class="font-semibold text-yellow-400">-</h4>
                                    <p id="resultConfidence" class="text-gray-400 text-sm">Confidence: -</p>
                                </div>
                                <button id="btnSaveCurrent" class="bg-gradient-to-r from-yellow-400 to-yellow-500 text-black px-4 py-2 rounded-lg font-semibold">
                                    Save
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="recent-identifications" class="space-y-3">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-yellow-400">Recent Identifications</h3>
                        <button id="btnClearRecent" class="text-xs text-gray-400 hover:text-yellow-400">Clear</button>
                    </div>
                    <div id="recentList" class="space-y-3">
                        <!-- Will be rendered dynamically -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 2 -->
        <div id="tab2-content" class="tab-content p-4">
            <div id="saved-eggs-section" class="space-y-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-yellow-400">Saved Eggs</h2>
                    <span id="savedCount" class="bg-yellow-400/20 text-yellow-400 px-3 py-1 rounded-full text-sm">0 saved</span>
                </div>

                <div id="savedList" class="space-y-4">
                    <!-- Saved cards injected here -->
                </div>
            </div>
        </div>

        <!-- Tab 3 -->
        <div id="tab3-content" class="tab-content p-4">
            <div id="care-methods-section" class="space-y-6">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-yellow-400 mb-2">Egg Care Guide</h2>
                    <p class="text-gray-300">Learn how to incubate and raise chicks</p>
                </div>

                <div class="space-y-4">
                    <div class="bg-gray-900 rounded-xl p-5 border border-yellow-400/20">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-12 h-12 bg-yellow-400/20 rounded-lg flex items-center justify-center">
                                <i class="fas fa-thermometer-half text-yellow-400"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-lg">Temperature Control</h3>
                                <p class="text-gray-400 text-sm">Maintain optimal incubation temperature</p>
                            </div>
                        </div>
                        <div class="bg-black/30 rounded-lg p-3">
                            <p class="text-yellow-400 font-semibold">37.5°C (99.5°F)</p>
                            <p class="text-gray-400 text-sm">Keep temperature stable ±0.5°C</p>
                        </div>
                    </div>

                    <div class="bg-gray-900 rounded-xl p-5 border border-yellow-400/20">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-12 h-12 bg-yellow-400/20 rounded-lg flex items-center justify-center">
                                <i class="fas fa-tint text-yellow-400"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-lg">Humidity Levels</h3>
                                <p class="text-gray-400 text-sm">Control moisture for healthy development</p>
                            </div>
                        </div>
                        <div class="bg-black/30 rounded-lg p-3">
                            <p class="text-yellow-400 font-semibold">55-60% RH</p>
                            <p class="text-gray-400 text-sm">Increase to 65% in final 3 days</p>
                        </div>
                    </div>

                    <div class="bg-gray-900 rounded-xl p-5 border border-yellow-400/20">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-12 h-12 bg-yellow-400/20 rounded-lg flex items-center justify-center">
                                <i class="fas fa-redo text-yellow-400"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-lg">Turning Schedule</h3>
                                <p class="text-gray-400 text-sm">Regular turning prevents sticking</p>
                            </div>
                        </div>
                        <div class="bg-black/30 rounded-lg p-3">
                            <p class="text-yellow-400 font-semibold">Every 4-6 hours</p>
                            <p class="text-gray-400 text-sm">Stop turning 3 days before hatching</p>
                        </div>
                    </div>

                    <div class="bg-gradient-to-r from-yellow-400/10 to-yellow-500/10 rounded-xl p-5 border border-yellow-400/30">
                        <h3 class="font-semibold text-lg text-yellow-400 mb-2">Incubation Timeline</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-gray-300">Chicken eggs:</span>
                                <span class="text-yellow-400">21 days</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-300">Duck eggs:</span>
                                <span class="text-yellow-400">28 days</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-300">Quail eggs:</span>
                                <span class="text-yellow-400">18 days</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 4 -->
        <div id="tab4-content" class="tab-content p-4">
            <div id="analytics-section" class="space-y-6">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-yellow-400 mb-2">Analytics</h2>
                    <p class="text-gray-300">Track your egg usage patterns</p>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-gray-900 rounded-xl p-4 border border-yellow-400/20 text-center">
                        <i class="fas fa-utensils text-yellow-400 text-2xl mb-2"></i>
                        <p id="statCooked" class="text-2xl font-bold text-yellow-400">0</p>
                        <p class="text-gray-400 text-sm">Cooked</p>
                    </div>
                    <div class="bg-gray-900 rounded-xl p-4 border border-yellow-400/20 text-center">
                        <i class="fas fa-heart text-yellow-400 text-2xl mb-2"></i>
                        <p id="statIncubated" class="text-2xl font-bold text-yellow-400">0</p>
                        <p class="text-gray-400 text-sm">Incubated</p>
                    </div>
                </div>

                <div class="bg-gray-900 rounded-xl p-5 border border-yellow-400/20">
                    <h3 class="font-semibold text-lg text-yellow-400 mb-4">Usage Distribution</h3>
                    <div id="usageChartContainer" class="relative">
                        <canvas id="usageChart"></canvas>
                    </div>
                </div>

                <div class="bg-gray-900 rounded-xl p-5 border border-yellow-400/20">
                    <h3 class="font-semibold text-lg text-yellow-400 mb-4">Species Breakdown</h3>
                    <div class="space-y-3" id="speciesBreakdown">
                        <!-- dynamic species rows -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <nav id="bottom-navigation" class="fixed bottom-0 left-1/2 transform -translate-x-1/2 w-full max-w-sm bg-gray-900 border-t border-yellow-400/20">
        <div class="flex">
            <button class="tab-button active flex-1 py-3 text-center" data-tab="1">
                <i class="fas fa-camera block text-xl mb-1"></i>
                <span class="text-xs">Identify</span>
            </button>
            <button class="tab-button flex-1 py-3 text-center text-gray-400" data-tab="2">
                <i class="fas fa-bookmark block text-xl mb-1"></i>
                <span class="text-xs">Saved</span>
            </button>
            <button class="tab-button flex-1 py-3 text-center text-gray-400" data-tab="3">
                <i class="fas fa-heart block text-xl mb-1"></i>
                <span class="text-xs">Care</span>
            </button>
            <button class="tab-button flex-1 py-3 text-center text-gray-400" data-tab="4">
                <i class="fas fa-chart-bar block text-xl mb-1"></i>
                <span class="text-xs">Analytics</span>
            </button>
        </div>
    </nav>
</div>

<!-- Modal -->
<div id="modalRoot" class="hidden fixed inset-0 z-[60] modal-backdrop flex items-end md:items-center justify-center p-4">
    <div class="bg-gray-900 border border-yellow-400/20 rounded-xl w-full max-w-sm shadow-xl">
        <div class="p-4 border-b border-yellow-400/10 flex items-center justify-between">
            <h3 id="modalTitle" class="text-yellow-400 font-semibold">Modal</h3>
            <button id="modalClose" class="text-gray-400 hover:text-yellow-400">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="modalBody" class="p-4 text-gray-200"></div>
        <div id="modalFooter" class="p-4 border-t border-yellow-400/10 flex items-center justify-end gap-2">
            <button id="modalCancel" class="px-4 py-2 bg-gray-800 rounded-lg text-gray-300">Close</button>
            <button id="modalOk" class="px-4 py-2 bg-gradient-to-r from-yellow-400 to-yellow-500 text-black rounded-lg font-semibold">OK</button>
        </div>
    </div>
</div>

<script>
    // Storage helpers
    const KEYS = {
      RECENT: 'egg_recent',
      SAVED: 'egg_saved',
      ANALYTICS: 'egg_analytics'
    };

    const defaultAnalytics = () => ({
      cooked: 127,
      incubated: 43,
      species: { Chicken: 89, Duck: 52, Quail: 29 }
    });

    function loadJSON(key, fallback) {
      try {
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : (typeof fallback === 'function' ? fallback() : (fallback ?? null));
      } catch {
        return typeof fallback === 'function' ? fallback() : (fallback ?? null);
      }
    }
    function saveJSON(key, value) {
      try { localStorage.setItem(key, JSON.stringify(value)); } catch {}
    }

    // In-memory state
    let recent = loadJSON(KEYS.RECENT, []);
    let saved = loadJSON(KEYS.SAVED, []);
    let analytics = loadJSON(KEYS.ANALYTICS, defaultAnalytics);

    // Tabs
    const tabButtons = Array.from(document.querySelectorAll('.tab-button'));
    const tabContents = {
      1: document.getElementById('tab1-content'),
      2: document.getElementById('tab2-content'),
      3: document.getElementById('tab3-content'),
      4: document.getElementById('tab4-content'),
    };

    tabButtons.forEach(btn => {
      btn.addEventListener('click', () => showTab(Number(btn.dataset.tab)));
    });

    function showTab(tabNumber) {
      Object.values(tabContents).forEach(c => c.classList.remove('active'));
      tabContents[tabNumber].classList.add('active');

      tabButtons.forEach(b => {
        b.classList.remove('active');
        b.classList.add('text-gray-400');
      });
      const btn = tabButtons[tabNumber - 1];
      btn.classList.add('active');
      btn.classList.remove('text-gray-400');

      if (tabNumber === 2) renderSaved();
      if (tabNumber === 4) {
        setTimeout(() => {
          initOrUpdateChart();
          renderAnalyticsCounts();
          renderSpeciesBreakdown();
        }, 50);
      }
    }

    // Identification (mock classifier)
    const speciesPool = [
      { name: 'Chicken Egg', key: 'Chicken' },
      { name: 'Duck Egg', key: 'Duck' },
      { name: 'Quail Egg', key: 'Quail' },
      { name: 'Goose Egg', key: 'Goose' },
      { name: 'Turkey Egg', key: 'Turkey' }
    ];
    function mockIdentify(imageDataUrl) {
      // Pseudo-random consistent classification based on image length hash
      const h = [...(imageDataUrl || '')].reduce((a, c) => (a + c.charCodeAt(0)) % 1000003, 0);
      const pick = speciesPool[h % speciesPool.length];
      const confidence = 80 + (h % 21); // 80..100
      return { title: pick.name, key: pick.key, confidence };
    }

    // Camera/Upload handling
    const fileInputCamera = document.getElementById('fileInputCamera');
    const fileInputUpload = document.getElementById('fileInputUpload');
    const btnCamera = document.getElementById('btnCamera');
    const btnUpload = document.getElementById('btnUpload');
    const tapToCapture = document.getElementById('tapToCapture');

    btnCamera.addEventListener('click', () => fileInputCamera.click());
    btnUpload.addEventListener('click', () => fileInputUpload.click());
    tapToCapture.addEventListener('click', () => fileInputCamera.click());

    fileInputCamera.addEventListener('change', onImageChosen);
    fileInputUpload.addEventListener('change', onImageChosen);

    async function onImageChosen(e) {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      const dataUrl = await fileToDataURL(file);
      showPreviewAndResult(dataUrl);
      // Clean value to allow re-select same file next time
      e.target.value = '';
    }

    function fileToDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    const previewBox = document.getElementById('previewBox');
    const previewImage = document.getElementById('previewImage');
    const resultTitle = document.getElementById('resultTitle');
    const resultConfidence = document.getElementById('resultConfidence');
    const btnSaveCurrent = document.getElementById('btnSaveCurrent');

    let lastResult = null;

    function showPreviewAndResult(dataUrl) {
      previewImage.src = dataUrl;
      previewBox.classList.remove('hidden');

      const res = mockIdentify(dataUrl);
      lastResult = { ...res, image: dataUrl, time: Date.now() };
      resultTitle.textContent = res.title;
      resultConfidence.textContent = `Confidence: ${res.confidence}%`;

      addRecent(lastResult);
      renderRecent();
      // Update analytics
      bumpAnalytics(res.key);
    }

    function addRecent(item) {
      recent.unshift(item);
      // keep only last 10
      if (recent.length > 10) recent = recent.slice(0, 10);
      saveJSON(KEYS.RECENT, recent);
    }

    function humanizeTime(ts) {
      const diff = Math.max(0, Date.now() - ts);
      const m = Math.floor(diff / 60000);
      if (m < 1) return 'just now';
      if (m < 60) return `${m} min ago`;
      const h = Math.floor(m / 60);
      if (h < 24) return `${h} hour${h>1?'s':''} ago`;
      const d = Math.floor(h / 24);
      return `${d} day${d>1?'s':''} ago`;
    }

    function renderRecent() {
      const container = document.getElementById('recentList');
      container.innerHTML = '';
      if (recent.length === 0) {
        container.innerHTML = `<p class="text-gray-500 text-sm">No recent identifications yet.</p>`;
        return;
      }
      recent.forEach((item, idx) => {
        const el = document.createElement('div');
        el.className = 'bg-gray-900 rounded-lg p-4 border border-yellow-400/20';
        el.innerHTML = `
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 bg-yellow-400/20 rounded-lg flex items-center justify-center overflow-hidden">
              ${item.image ? `<img src="${item.image}" alt="" class="w-12 h-12 object-cover">` : `<i class="fas fa-egg text-yellow-400"></i>`}
            </div>
            <div class="flex-1">
              <h4 class="font-semibold">${item.title}</h4>
              <p class="text-gray-400 text-sm">Confidence: ${item.confidence}%</p>
            </div>
            <div class="text-right">
              <p class="text-xs text-gray-500">${humanizeTime(item.time)}</p>
              <button class="text-yellow-400 text-sm underline" data-action="save" data-idx="${idx}">Save</button>
            </div>
          </div>
        `;
        container.appendChild(el);
      });
      container.querySelectorAll('button[data-action="save"]').forEach(btn => {
        btn.addEventListener('click', () => {
          const idx = Number(btn.dataset.idx);
          saveIdentification(recent[idx]);
        });
      });
    }

    document.getElementById('btnClearRecent').addEventListener('click', () => {
      recent = [];
      saveJSON(KEYS.RECENT, recent);
      renderRecent();
    });

    function saveIdentification(item) {
      if (!item) return;
      const id = 'egg_' + Math.random().toString(36).slice(2);
      const rec = { id, ...item, note: '', tags: [] };
      saved.unshift(rec);
      saveJSON(KEYS.SAVED, saved);
      renderSaved();
      showModal({
        title: 'Saved',
        body: `<p class="text-sm text-gray-300">Identification saved to your list.</p>`,
        okText: 'Great',
        cancelText: 'Close'
      });
    }

    btnSaveCurrent.addEventListener('click', () => {
      if (lastResult) saveIdentification(lastResult);
    });

    // Saved list
    function renderSaved() {
      const container = document.getElementById('savedList');
      const savedCount = document.getElementById('savedCount');
      savedCount.textContent = `${saved.length} saved`;
      container.innerHTML = '';

      if (saved.length === 0) {
        container.innerHTML = `<p class="text-gray-500 text-sm">No saved eggs yet. Save identifications to see them here.</p>`;
        return;
      }

      saved.forEach(item => {
        const el = document.createElement('div');
        el.className = 'bg-gray-900 rounded-xl p-4 border border-yellow-400/20';
        el.innerHTML = `
          <div class="flex items-center gap-4 mb-3">
            <div class="w-16 h-16 bg-yellow-400/20 rounded-lg flex items-center justify-center overflow-hidden">
              ${item.image ? `<img src="${item.image}" alt="" class="w-16 h-16 object-cover">` : `<i class="fas fa-egg text-yellow-400 text-xl"></i>`}
            </div>
            <div class="flex-1">
              <h3 class="font-semibold text-lg">${item.title}</h3>
              <p class="text-gray-400 text-sm">Saved ${humanizeTime(item.time)}</p>
              <p class="text-yellow-400 text-xs">Confidence ${item.confidence}%</p>
            </div>
            <div class="flex flex-col gap-2">
              <button class="px-3 py-1 bg-gray-800 text-gray-200 rounded-lg text-xs" data-action="view" data-id="${item.id}">
                <i class="fas fa-eye mr-1"></i> View
              </button>
              <button class="px-3 py-1 bg-gray-800 text-red-300 rounded-lg text-xs" data-action="remove" data-id="${item.id}">
                <i class="fas fa-trash mr-1"></i> Delete
              </button>
            </div>
          </div>
          <button class="w-full bg-gradient-to-r from-yellow-400 to-yellow-500 text-black py-3 rounded-lg font-semibold" data-action="recipe" data-id="${item.id}">
            <i class="fas fa-utensils mr-2"></i>Create Recipe
          </button>
        `;
        container.appendChild(el);
      });

      container.querySelectorAll('button[data-action="view"]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          const item = saved.find(x => x.id === id);
          if (!item) return;
          showModal({
            title: item.title,
            body:
              `<div class="space-y-3">
                <div class="w-full rounded-lg overflow-hidden border border-yellow-400/20">
                  ${item.image ? `<img src="${item.image}" class="w-full object-cover max-h-72">` : ''}
                </div>
                <p class="text-sm text-gray-300 truncate-2">Confidence: ${item.confidence}%</p>
                <textarea id="note_${item.id}" class="w-full bg-black/40 border border-yellow-400/20 rounded-lg p-2 text-sm" placeholder="Add note...">${item.note || ''}</textarea>
                <div class="flex gap-2 flex-wrap">
                  ${renderTags(item.tags)}
                  <input id="tagInput_${item.id}" class="flex-1 min-w-[120px] bg-black/40 border border-yellow-400/20 rounded-lg p-2 text-sm" placeholder="Add tag">
                  <button id="addTag_${item.id}" class="px-3 py-2 bg-gray-800 rounded-lg text-sm">Add</button>
                </div>
              </div>`,
            okText: 'Save',
            cancelText: 'Close',
            onOk: () => {
              const note = document.getElementById(`note_${item.id}`).value;
              const tagInput = document.getElementById(`tagInput_${item.id}`);
              // persist possible input not added via button
              if (tagInput.value.trim()) {
                item.tags.push(tagInput.value.trim());
              }
              item.note = note;
              item.tags = Array.from(new Set(item.tags)).slice(0, 12);
              saveJSON(KEYS.SAVED, saved);
              renderSaved();
            }
          });

          setTimeout(() => {
            const addBtn = document.getElementById(`addTag_${item.id}`);
            const input = document.getElementById(`tagInput_${item.id}`);
            addBtn?.addEventListener('click', () => {
              const val = input.value.trim();
              if (!val) return;
              item.tags.push(val);
              input.value = '';
              // Reopen content area quickly:
              document.getElementById('modalBody').innerHTML = document.getElementById('modalBody').innerHTML.replace('</div></div>', '');
            });
          }, 0);
        });
      });

      container.querySelectorAll('button[data-action="remove"]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          saved = saved.filter(x => x.id !== id);
          saveJSON(KEYS.SAVED, saved);
          renderSaved();
        });
      });

      container.querySelectorAll('button[data-action="recipe"]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          const item = saved.find(x => x.id === id);
          showModal({
            title: 'Create Recipe',
            body: `<p class="text-sm text-gray-300">Feature coming soon. We’ll suggest recipes for <span class="text-yellow-400 font-semibold">${item?.title || 'your egg'}</span>.</p>`,
            okText: 'OK',
            cancelText: 'Close'
          });
        });
      });
    }

    function renderTags(tags) {
      if (!tags || tags.length === 0) return '';
      return tags.slice(0, 12).map(t =>
        `<span class="px-2 py-1 bg-yellow-400/10 text-yellow-400 rounded text-xs">#${escapeHtml(t)}</span>`
      ).join(' ');
    }

    // Analytics
    let usageChart = null;
    function initOrUpdateChart() {
      const ctx = document.getElementById('usageChart');
      if (!ctx) return;

      const data = {
        labels: ['Cooked', 'Incubated'],
        datasets: [{
          data: [analytics.cooked, analytics.incubated],
          backgroundColor: ['#FBBF24', '#F59E0B'],
          borderWidth: 0
        }]
      };
      const options = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom', labels: { color: '#FBBF24' } }
        }
      };

      if (usageChart) {
        usageChart.data = data;
        usageChart.update();
      } else {
        usageChart = new Chart(ctx, { type: 'doughnut', data, options });
      }
    }

    function renderAnalyticsCounts() {
      document.getElementById('statCooked').textContent = analytics.cooked;
      document.getElementById('statIncubated').textContent = analytics.incubated;
    }

    function renderSpeciesBreakdown() {
      const holder = document.getElementById('speciesBreakdown');
      holder.innerHTML = '';
      const palette = ['#FBBF24', '#FDE68A', '#F59E0B', '#FACC15', '#FCD34D', '#EAB308'];
      const entries = Object.entries(analytics.species);
      if (entries.length === 0) {
        holder.innerHTML = `<p class="text-gray-500 text-sm">No species data yet.</p>`;
        return;
      }
      entries.forEach(([name, count], i) => {
        const color = palette[i % palette.length];
        const row = document.createElement('div');
        row.className = 'flex items-center justify-between';
        row.innerHTML = `
          <div class="flex items-center gap-3">
            <div class="w-4 h-4 rounded" style="background:${color}"></div>
            <span>${escapeHtml(name)}</span>
          </div>
          <span class="text-yellow-400 font-semibold">${count}</span>
        `;
        holder.appendChild(row);
      });
    }

    function bumpAnalytics(speciesKey) {
      // For demo: randomly increment cooked or incubated
      const incCooked = Math.random() < 0.6;
      if (incCooked) analytics.cooked++; else analytics.incubated++;
      analytics.species[speciesKey] = (analytics.species[speciesKey] || 0) + 1;
      saveJSON(KEYS.ANALYTICS, analytics);

      // Refresh UI where visible
      if (tabContents[4].classList.contains('active')) {
        initOrUpdateChart();
        renderAnalyticsCounts();
        renderSpeciesBreakdown();
      }
    }

    // Modal
    const modalRoot = document.getElementById('modalRoot');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');
    const modalOk = document.getElementById('modalOk');
    const modalCancel = document.getElementById('modalCancel');
    const modalClose = document.getElementById('modalClose');
    let modalOkHandler = null;

    function showModal({ title, body, okText = 'OK', cancelText = 'Close', onOk = null }) {
      modalTitle.textContent = title || 'Info';
      modalBody.innerHTML = body || '';
      modalOk.textContent = okText;
      modalCancel.textContent = cancelText;
      modalOkHandler = typeof onOk === 'function' ? onOk : null;
      modalRoot.classList.remove('hidden');
    }
    function hideModal() {
      modalRoot.classList.add('hidden');
      modalOkHandler = null;
    }
    modalOk.addEventListener('click', () => { if (modalOkHandler) modalOkHandler(); hideModal(); });
    modalCancel.addEventListener('click', hideModal);
    modalClose.addEventListener('click', hideModal);
    modalRoot.addEventListener('click', (e) => { if (e.target === modalRoot) hideModal(); });

    // Utils
    function escapeHtml(s) {
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    // Initial render
    renderRecent();
    renderSaved();

    // Analytics initial paint when tab opened
    let observerForTab4 = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          initOrUpdateChart();
          renderAnalyticsCounts();
          renderSpeciesBreakdown();
          observerForTab4.disconnect();
        }
      });
    }, { root: null, threshold: 0.2 });
    observerForTab4.observe(document.getElementById('tab4-content'));
</script>
</body>
</html>